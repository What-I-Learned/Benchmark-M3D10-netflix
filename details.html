<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
      integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <title>Striveflix</title>
  </head>

  <body>
    <div class="container-fluid text-white px-5">
      <nav class="navbar navbar-expand-lg navbar-dark pr-0">
        <a class="navbar-brand mr-0" href="#"
          ><img src="./assets/imgs/Netflix_Logo_RGB.png" width="160"
        /></a>
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item ">
              <a class="nav-link" href="backoffice.html">Add a movie </a>
            </li>
            <li class="nav-item active">
              <a class="nav-link" href="#"
                >Movies DB <span class="sr-only">(current)</span></a
              >
            </li>
          </ul>

          <div class="text-white navbar-nav align-items-center">
            <i class="fas fa-lg fa-search mr-2"></i>
            <div class="btn-group ml-2">
              <button
                type="button"
                class="btn dropdown-toggle text-white p-0"
                data-toggle="dropdown"
                aria-haspopup="true"
                aria-expanded="false"
              >
                <i class="fas fa-lg fa-user-circle"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-right">
                <a href="index.html">
                  <button class="dropdown-item" type="button">
                    Home Page
                  </button></a
                >
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div class="position-relative">
        <div class="header-tools d-inline-block">
          <div class="header-icons d-inline-block">
            <span
              class="d-inline-block px-2 border align-middle"
              style="padding-top: 0.4rem; padding-bottom: 0.4rem"
              ><i class="fas fa-align-left"></i
            ></span>
            <span
              class="d-inline-block px-2 border border-secondary align-middle"
              style="padding-top: 0.4rem; padding-bottom: 0.4rem"
              ><i class="fas fa-border-all"></i
            ></span>
          </div>
        </div>
      </div>
    </div>
    <main class="container-fluid text-white px-5" style="clear: both">
        <div class="category-container">
            <div class="category-container-inner">
            <h4 class="mb-3 mt-5 category-header">Movies in data base</h4>
    </div>
    <div class="spinner-container d-flex justify-content-center align-items-center">
    <div class="spinner-border spinner-border-sm d-none" role="status">
      <span class="sr-only">Loading...</span>
  </div>
</div>
    </main>

    <footer>
      <div class="container text-muted my-5">
        <div class="row justify-content-center">
          <div class="col-8">
            <div class="row">
              <div class="col-12 mb-3">
                <i class="fab fa-facebook-square fa-lg mr-3"></i>
                <i class="fab fa-instagram fa-lg mr-3"></i>
                <i class="fab fa-twitter fa-lg mr-3"></i>
                <i class="fab fa-youtube fa-lg"></i>
              </div>
              <div class="col-md-3">
                <small>
                  <ul class="list-unstyled">
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                  </ul>
                </small>
              </div>
              <div class="col-md-3">
                <small>
                  <ul class="list-unstyled">
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                  </ul>
                </small>
              </div>
              <div class="col-md-3">
                <small>
                  <ul class="list-unstyled">
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                  </ul>
                </small>
              </div>
              <div class="col-md-3">
                <small>
                  <ol class="list-unstyled">
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                    <li class="mb-2">menu item</li>
                  </ol>
                </small>
              </div>
            </div>
            <button
              class="
                btn btn-sm
                border border-secondary
                rounded-0
                text-muted
                mt-3
              "
            >
              <small>Service Code</small>
            </button>
            <div class="mt-2"><small>i'm a copyright</small></div>
          </div>
        </div>
      </div>
    </footer>

    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
      crossorigin="anonymous"
    ></script>
    <script>
const authorization = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2MTFjZjk1ZTJkNTI2MjAwMTViNmRjOWQiLCJpYXQiOjE2Mjk0NjE2NzEsImV4cCI6MTYzMDY3MTI3MX0.Lxq9IxiDoIiUpDLh6lUCm2ggvoCwzoeRlwOEca-x-Vg"
const url = "https://striveschool-api.herokuapp.com/api/movies/"
        window.onload = ()=>{
          fetchMovies(url);

        } 
        async function fetchMovies(url){
          isLoading(true)
            try{

                const response = await fetch(url,{
                    headers:{
                        Authorization:authorization
                ,               

                    }
                });
                if(response.ok){
                    const moviesData = await response.json()
                    console.log(moviesData);
                    displayMovies(moviesData)
                }
            }catch(err){
                console.log(err);
            }finally{
                isLoading(false)
            }

          function displayMovies(data){
                let moviesContainer = document.querySelector(".category-container")

                data.forEach(movieGenre => {
                    let genreContainer = document.createElement("div")
                    genreContainer.classList.add("category-container-inner")
                    genreContainer.id = `${movieGenre}`
                    
                    genreContainer.innerHTML=`<h4 class="mb-3 mt-5 category-header">${movieGenre.charAt(0).toUpperCase() + movieGenre.slice(1)}</h4>`
                 

                    moviesContainer.append(genreContainer)
                    
                    fetchMoviesByGenre(url,movieGenre,genreContainer.id)
                    
                });
            }
        }

        async function fetchMoviesByGenre(url, genre,place){
          isLoading(true)
            let container=place
            try{

                const response = await fetch(url+genre,{
                    headers:{
                        Authorization:authorization,}
                });
                if(response.ok){
                    const moviesData = await response.json()
                    console.log(moviesData);
                    // return moviesData
                    displayMoviesyGenre(moviesData,container)
                }
            }catch(err){
                console.log(err);
            }finally{
              isLoading(false)
            }
        } 

        function displayMoviesyGenre(moviesByGenre,container){
            let divContainer = document.getElementById(container)

            let movieItem = document.createElement("div")
            movieItem.classList.add("row" ,"row-cols-1" ,"row-cols-sm-2", "row-cols-md-3", "row-cols-lg-6", "mx-n1", "movie-container")
            divContainer.append(movieItem)
            moviesByGenre.forEach(movie => {
                let movieItemInner = document.createElement("div")
                // movieItemInner.classList.add("col", "mb-2", "mb-lg-0", "px-1")
                movieItemInner.innerHTML =`<div class="card" style="width: 18rem;">
                  <div class="movie-image">
                  <img src="${movie.imageUrl}" class="card-img-top" alt="...">
                  </div>
                  <div class="card-body">
                    <h5 class="card-title">${movie.name}</h5>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item"><span style="display:block">Create at:</span>${new Date(movie.createdAt).toLocaleString()}</li>
                  </ul>
                  <div class="options d-flex justify-content-between">
                    <a href="#" id="edit-btn" onclick="handleEdit('${movie.category}','${movie._id}')" class="card-link">Edit</a>
                    <a href="#" id="delete-btn" onclick="handleDelete('${movie._id}')"  class="card-link">Delete</a>
                  </div>
                  </div>`
              
                
                console.log(movieItem);
                movieItem.append(movieItemInner)
            });
        }

        async function handleDelete(movieId){
          isLoading(true)
          console.log(movieId);
            try {
                const response = await fetch(url+movieId, { method: "DELETE",headers:{
                        Authorization:authorization,}})
                if (response.ok) {
                    const deletedObj = await response.json()

                    // refresh the db
                    location.reload();
                    // showAlert("success", "Event with id: " + deletedObj._id + " deleted successfully") // shows the custom alert
                    // setTimeout(() => { window.location.assign("/") }, 3500) // pushes the user to the homepage after 3,5 seconds
                } else {
                    // showAlert("danger", "Something went wrong in the deletion process")
                }
            } catch (err) {
                // showAlert("danger", err.message)
            }finally{
              isLoading(false)
            }
        }

        const isLoading = (loading) => {
            if (loading) {
                document.querySelector(".spinner-border").classList.remove("d-none")
                document.querySelector(".spinner-container").classList.add("d-flex")
                document.querySelector(".spinner-container").classList.remove("d-none")

            } else {
                document.querySelector(".spinner-border").classList.add("d-none")
                document.querySelector(".spinner-container").classList.remove("d-flex")
                document.querySelector(".spinner-container").classList.add("d-none")
            }
        }

        const handleEdit = (genre,movieId) => {
          console.log(`./backoffice.html/?genre=${genre}&id=${movieId}`);
           window.location.assign(`./backoffice.html/?genre=${genre}&id=${movieId}`)
        }
    </script>
  </body>
</html>
